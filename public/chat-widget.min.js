class LacoProChat{constructor(t={}){this.options={position:t.position||"bottom-right",primaryColor:t.primaryColor||"#00C853",autoOpen:t.autoOpen||false,autoOpenDelay:t.autoOpenDelay||11000,...t},this.init()}init(){const t=document.createElement("style");t.textContent=`
.tiempoespacio-chat-widget{position:fixed;z-index:9999;${this.options.position.includes("bottom")?"bottom: 20px;":"top: 20px;"}${this.options.position.includes("right")?"right: 20px;":"left: 20px;"}}
.tiempoespacio-chat-button{width:80px;height:80px;border-radius:50%;background:${this.options.primaryColor};color:white;border:none;cursor:pointer;box-shadow:0 4px 15px rgba(0,0,0,0.2);display:flex;align-items:center;justify-content:center;font-size:40px;transition:transform 0.3s,box-shadow 0.3s}
.tiempoespacio-chat-button:hover{transform:scale(1.1);box-shadow:0 6px 20px rgba(0,0,0,0.25)}
.tiempoespacio-chat-window{display:none;position:fixed;bottom:120px;right:20px;width:350px;height:500px;background:white;border-radius:15px;box-shadow:0 5px 20px rgba(0,0,0,0.2);overflow:hidden;z-index:9999}
.tiempoespacio-chat-header{background:${this.options.primaryColor};color:white;padding:15px;display:flex;justify-content:space-between;align-items:center;font-weight:bold}
.tiempoespacio-chat-close{background:none;border:none;color:white;cursor:pointer;font-size:24px;padding:5px}
.tiempoespacio-chat-messages{height:calc(100% - 140px);overflow-y:auto;padding:15px;margin-bottom:80px}
.tiempoespacio-chat-message{margin-bottom:10px;padding:10px;border-radius:10px;max-width:80%;color:#000000}
.tiempoespacio-chat-message a{color:#0066cc;text-decoration:underline;cursor:pointer}
.tiempoespacio-chat-message a:hover{color:#0052a3}
.tiempoespacio-chat-message a.whatsapp-link{color:#25D366;font-weight:bold;display:inline-block;padding:8px 12px;background:#25D366;color:white;border-radius:18px;text-decoration:none;margin-top:5px;box-shadow:0 2px 5px rgba(0,0,0,0.2)}
.tiempoespacio-chat-message a.whatsapp-link:hover{background:#1fad55;box-shadow:0 3px 8px rgba(0,0,0,0.3)}
.tiempoespacio-chat-message .whatsapp-contact{font-weight:bold;color:#075e54;margin-right:8px}
.tiempoespacio-chat-user{background:#e3f2fd;margin-left:auto;color:#000000}
.tiempoespacio-chat-bot{background:#f5f5f5;color:#000000}
.tiempoespacio-chat-input{padding:15px;border-top:1px solid #eee;display:flex;gap:10px;background:white;position:absolute;bottom:0;left:0;right:0;box-sizing:border-box}
.tiempoespacio-chat-input textarea{flex:1;padding:12px;border:1px solid #ddd;border-radius:10px;resize:none;height:50px;font-family:inherit;font-size:14px;line-height:1.4;box-sizing:border-box;color:#000000}
.tiempoespacio-chat-input button{padding:12px 20px;background:${this.options.primaryColor};color:white;border:none;border-radius:10px;cursor:pointer;height:50px;min-width:80px;font-weight:bold;font-size:14px;transition:background-color 0.3s}
.tiempoespacio-chat-input button:hover{opacity:0.9}
.tiempoespacio-chat-loading{display:none;text-align:center;padding:10px;color:#000000}
.tiempoespacio-chat-loading::after{content:'...';animation:dots 1.5s steps(4,end) infinite}
@keyframes dots{0%,20%{content:'.'} 40%{content:'..'} 60%{content:'...'} 80%,100%{content:''}}`,document.head.appendChild(t);const e=document.createElement("button");e.className="tiempoespacio-chat-widget tiempoespacio-chat-button",e.innerHTML="ðŸ“±",document.body.appendChild(e);const s=document.createElement("div");s.className="tiempoespacio-chat-window",s.innerHTML=`
<div class="tiempoespacio-chat-header">
<span>Chat Lacopro</span>
<button class="tiempoespacio-chat-close">Ã—</button>
</div>
<div class="tiempoespacio-chat-messages"></div>
<div class="tiempoespacio-chat-loading">Pensando</div>
<div class="tiempoespacio-chat-input">
<textarea placeholder="Escribe tu mensaje..." rows="3"></textarea>
<button>Enviar</button>
</div>`,document.body.appendChild(s),this.chatWindow=s,this.messagesContainer=s.querySelector(".tiempoespacio-chat-messages"),this.input=s.querySelector("textarea"),this.sendButton=s.querySelector(".tiempoespacio-chat-input button"),this.closeButton=s.querySelector(".tiempoespacio-chat-close"),this.loading=s.querySelector(".tiempoespacio-chat-loading"),this.chatButton=e;

// Inicializar eventos
this.chatButton.addEventListener("click",()=>this.toggleChat());
this.sendButton.addEventListener("click",()=>this.sendMessage());
this.closeButton.addEventListener("click",()=>this.toggleChat());
this.input.addEventListener("keypress",t=>{"Enter"!==t.key||t.shiftKey||(t.preventDefault(),this.sendMessage())});

this.addMessage("Hola ðŸ‘‹ Â¿CÃ³mo te puedo ayudar hoy?","bot");

// Configurar apertura automÃ¡tica
if(this.options.autoOpen){
    setTimeout(()=>{
        this.openChat();
    },this.options.autoOpenDelay);
}}

toggleChat(){
    if(this.chatWindow.style.display==="block"){
        this.closeChat();
    }else{
        this.openChat();
    }
}

openChat(){
    this.chatWindow.style.display="block";
    this.input.focus();
}

closeChat(){
    this.chatWindow.style.display="none";
}

addMessage(t,e){const s=document.createElement("div");s.className=`tiempoespacio-chat-message tiempoespacio-chat-${e}`;
// Si es un mensaje del bot, procesar los enlaces
if(e==="bot"){s.innerHTML=this.sanitizeHTML(t);}else{s.textContent=t;}
this.messagesContainer.appendChild(s),this.messagesContainer.scrollTop=this.messagesContainer.scrollHeight}sanitizeHTML(t){
    // Paso 1: Eliminar completamente cualquier etiqueta o atributo HTML visible
    t = t.replace(/class="[^"]*"/g, '');
    t = t.replace(/target="[^"]*"/g, '');
    t = t.replace(/rel="[^"]*"/g, '');
    
    // Paso 2: Limpiar completamente cualquier formateo mal hecho de WhatsApp
    const cleanPhrase = (str) => {
        // Quitar mÃºltiples espacios
        return str.replace(/\s+/g, ' ').trim();
    };
    
    // Paso 3: Eliminar los iconos y clases duplicados de WhatsApp
    t = t.replace(/(?:ðŸŸ¢|ðŸ’¬|ðŸ“±)?\s*\+56992322998(?:\s*class="[^"]*")*/g, '+56992322998');
    t = t.replace(/https:\/\/wa\.me\/\+56992322998(?:\s*class="[^"]*")*/g, 'https://wa.me/+56992322998');
    
    // Paso 4: Limpiar URLs malformadas de WhatsApp
    t = t.replace(/https:\/\/wa\.me\/https:\/\/wa\.me\/\+56992322998/g, 'https://wa.me/+56992322998');
    
    // Paso 5: Procesar nÃºmero de telÃ©fono y URL de WhatsApp correctamente (solo una vez por tipo)
    let hasProcessedPhone = false;
    let hasProcessedUrl = false;
    
    // Convertir SOLO la primera apariciÃ³n del nÃºmero de telÃ©fono
    t = t.replace(/\+56992322998/g, (match) => {
        if (!hasProcessedPhone) {
            hasProcessedPhone = true;
            return `<span class="whatsapp-contact">ðŸ“± ${match}</span>`;
        }
        return match;
    });
    
    // Convertir SOLO la primera apariciÃ³n del enlace de WhatsApp
    t = t.replace(/https:\/\/wa\.me\/\+56992322998/g, (match) => {
        if (!hasProcessedUrl) {
            hasProcessedUrl = true;
            return `<a href="${match}" class="whatsapp-link">ðŸ’¬ Contactar por WhatsApp</a>`;
        }
        return match;
    });
    
    // Paso 6: Procesar otras URLs normales (que no sean de WhatsApp)
    t = t.replace(/(https?:\/\/(?!wa\.me)[^\s"'<>]+)/g, (match) => {
        if (match.includes('<a href')) return match;
        const cleanUrl = match.replace(/['"<>]/g, '');
        return `<a href="${cleanUrl}">${cleanUrl}</a>`;
    });
    
    return cleanPhrase(t);
}async sendMessage(){const t=this.input.value.trim();if(!t)return;this.addMessage(t,"user"),this.input.value="",this.loading.style.display="block";try{const e=await fetch("https://lacopro-chatbot.onrender.com/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:t,sessionId:"session-"+Math.random().toString(36).substr(2,9)})});const data=await e.json();if(data.error)throw new Error(data.error);
    
    // Pre-procesar la respuesta para limpiar URLs incorrectas de WhatsApp antes de aÃ±adirla
    let cleanedReply = data.reply;
    cleanedReply = cleanedReply.replace(/https:\/\/wa\.me\/https:\/\/wa\.me\/\+56992322998/g, 'https://wa.me/+56992322998');
    
    this.addMessage(cleanedReply,"bot")}catch(t){console.error("Error:",t),this.addMessage("Lo siento, hubo un error al procesar tu mensaje. Por favor, intenta de nuevo.","bot")}finally{this.loading.style.display="none"}}}window.LacoProChat=LacoProChat; 